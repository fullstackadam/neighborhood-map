
function MapVM(){const SELF=this;SELF.googleMapsLoaded=ko.observable(false);SELF.initialLoadPlaces=ko.observable().syncWith('initialLoadPlaces',true);SELF.createMap=function(){window.map=true;SELF.loadingState('rendering map...');window.map=new google.maps.Map(document.getElementById('map'),{center:{lat:SELF.location().position.lat,lng:SELF.location().position.lng,},scrollbar:false,zoom:14,rotateControl:true,});mapRenderedListener=window.map.addListener('idle',function(){SELF.loadingState('Map rendered');SELF.initialLoadPlaces(true);mapRenderedListener.remove();});};SELF.loadingState=ko.observable().syncWith('loadingState',true);SELF.location=ko.observable().subscribeTo('currentLocation',true);SELF.location.subscribe(function(){if(window.map!==null&&typeof window.map==='object'){SELF.center();}});SELF.places=ko.observableArray().subscribeTo('places',true);SELF.infoWindows=ko.observableArray();SELF.triggerCenter=ko.observable(false).syncWith('centerMap');SELF.markerActionQueue=ko.observableArray().syncWith('markerActionQueue',true);SELF.markerActionQueue.subscribe(function(value){if(SELF.markerActionQueue().length!==0){const action=SELF.markerActionQueue.shift();SELF.markers()[action.id][action['action']]();}});SELF.center=function(){window.map.setCenter({lat:SELF.location().position.lat,lng:SELF.location().position.lng,});};SELF.oldMarkers=[];SELF.deleteOldMarkers=function(){SELF.oldMarkers.forEach(function(marker){marker.setMap(null);});};SELF.markers=ko.computed(function(){let markers=[],marker;SELF.places().forEach(function(place,index){marker=new Marker(window.map,place);markerIndex=markers.push(marker)-1;SELF.places()[index].markerId=markerIndex;});SELF.deleteOldMarkers();SELF.oldMarkers=markers;return markers;},SELF);SELF.render=ko.observable().syncWith('loadMap',true);SELF.render.subscribe(function(value){if(window.map===null&&value&&SELF.googleMapsLoaded()){SELF.createMap();}});SELF.googleMapsLoaded.subscribe(function(value){if(window.map===null&&value&&SELF.render()){SELF.createMap();}});SELF.triggerCenter.subscribe(function(value){if(window.map!==null&&value){SELF.center();SELF.triggerCenter(false);}});window.addEventListener('resize',function(){$('#map').height(window.innerHeight-50);});$('#map').height(window.innerHeight-50);}