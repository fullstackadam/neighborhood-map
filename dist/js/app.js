
const Place=function Place(place){const SELF=this;let hours='N/A';SELF.id=ko.observable(place.id);SELF.name=ko.observable(place.title);SELF.category=ko.observable(place.category.id);SELF.lat=ko.observable(place.position[0]);SELF.lng=ko.observable(place.position[1]);SELF.icon=ko.observable(place.icon);if(place.openingHours!==undefined){hours=place.openingHours.text;}
SELF.hours=ko.observable(hours);SELF.address=ko.observable(place.vicinity);};function ViewModel(){const SELF=this;SELF.map=null;SELF.firstRun=true;SELF.defaultCities=ko.observableArray([{name:'New York, NY',position:{lat:40.7128,lng:-74.0059,},},{name:'San Francisco, CA',position:{lat:37.7749,lng:-122.4194,},},{name:'Denver, CO',position:{lat:39.7392,lng:-104.9903,},},{name:'London, UK',position:{lat:51.5074,lng:-0.1278,},},{name:'Manila, PH',position:{lat:14.5995,lng:120.9842,},}]);SELF.currentLocation=ko.observable(SELF.defaultCities()[2]);SELF.currentLocation.subscribe(function(newLocation){if(SELF.firstRun){return false;}
ko.utils.arrayForEach(SELF.places(),function(place){if(place.marker!==undefined){place.marker.setMap(null);}});SELF.places([]);SELF.recenterMap();SELF.categoryFilter(['all']);octopus.getPlaces(newLocation.position.lat,newLocation.position.lng,octopus.addMarkers);});SELF.recenterMap=function recenterMap(){SELF.map.setCenter({lat:SELF.currentLocation().position.lat,lng:SELF.currentLocation().position.lng,});};SELF.categoryFilter=ko.observable(['all']);SELF.places=ko.observableArray([]);SELF.placeCategories=ko.computed(function(){const CATEGORIES=['all'];ko.utils.arrayForEach(SELF.places(),function(place){const CATEGORY=place.category();if(CATEGORIES.indexOf(CATEGORY)===-1){CATEGORIES.push(CATEGORY);}});return CATEGORIES;},SELF);SELF.addMarker=function addMarker(place){const MARKER=new google.maps.Marker({animation:google.maps.Animation.DROP,position:place.position,icon:place.icon,map:SELF.map,});return MARKER;};SELF.addPlace=function addPlace(place){SELF.places.push(new Place(place));};SELF.addCategory=function addCategory(category){if(SELF.placeCategories.indexOf(category)===-1){SELF.placeCategories.push(category);}};SELF.filteredPlaces=ko.computed(function(){const CATEGORY_FILTER=SELF.categoryFilter()[0];return ko.utils.arrayFilter(SELF.places(),function(place){let keep=false;if(place.category()===CATEGORY_FILTER||CATEGORY_FILTER==='all'){keep=true;}
if(place.marker!==undefined){place.marker.setVisible(keep);}
return keep;});},SELF);SELF.onMouseoverListItem=function onMouseoverListItem(place){place.marker.defaultIcon=place.marker.icon;place.marker.setIcon('/images/here.png');};SELF.onMouseoutListItem=function onMouseoutListItem(place){place.marker.setAnimation(null);place.marker.setIcon(place.marker.defaultIcon);if(place.infoWindow!==undefined){place.infoWindow.close();place.infoWindow.opened=false;}};SELF.onClickListItem=function onClickListItem(place){if(place.infoWindow===undefined){const HTML=`<h3> ${place.name()}</h3>`+`<p><strong>Address:</strong> ${place.address()}</p>`+`<p><strong>Hours:</strong> ${place.hours()}</p>`;place.infoWindow=new google.maps.InfoWindow({content:HTML,});}
if(!place.infoWindow.opened){place.infoWindow.open(SELF.map,place.marker);place.infoWindow.opened=true;}
place.marker.setAnimation(google.maps.Animation.BOUNCE);};SELF.onCitySelection=function onCitySelection(city){SELF.currentLocation(city);};SELF.onFilterSelection=function onFilterSelection(filter){SELF.categoryFilter([filter])};}
const VM=new ViewModel();const octopus={addMarkers(){VM.places().forEach(function(place){const LAT=place.lat();const LNG=place.lng();place.marker=VM.addMarker({position:{lat:LAT,lng:LNG,},icon:place.icon(),});place.marker.addListener('click',function(){VM.onClickListItem(place);});});},getPlaces(lat,lng,callback){VM.firstRun=false;const platform=new H.service.Platform({app_id:'JaSjic2QLCII4hn6wa2V',app_code:'-9DtJ2wENRacgkqeW0haBg',});let search=new H.places.Explore(platform.getPlacesService());let searchResult;let error;const PARAMS={at:lat+','+lng,};function onResult(data){data.results.items.forEach(function(place,id){location.id=id;VM.addPlace(place);});if(callback!==null){callback();}}
function onError(data){error=data;}
search.request(PARAMS,{},onResult,onError);},};function initMap(){function showPosition(){VM.map=new google.maps.Map(document.getElementById('map'),{center:{lat:VM.currentLocation().position.lat,lng:VM.currentLocation().position.lng,},scrollbar:false,zoom:14,rotateControl:true,});octopus.getPlaces(VM.currentLocation().position.lat,VM.currentLocation().position.lng,octopus.addMarkers);}
function updateLatLng(position){const geocoder=new google.maps.Geocoder;const latlng={lat:position.coords.latitude,lng:position.coords.longitude,};geocoder.geocode({'location':latlng},function(results,status){console.log(results);results=results[0].address_components;let types=[];let city=false;let state=false;for(let i=0;i<results.length;i++){types=results[i].types;for(let j=0;j<types.length;j++){if(!city&&types[j]==='locality'){city=results[i].short_name;}
if(!state&&types[j]==='administrative_area_level_1'){state=results[i].short_name;}}}
const name=city+', '+state;VM.defaultCities.unshift({name:name,position:latlng,});VM.currentLocation({name:name,position:latlng,});showPosition();});}
function getLocation(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(updateLatLng);}else{showPosition();}}
getLocation();}
ko.applyBindings(VM);window.addEventListener('resize',function(){$('#map').height(window.innerHeight-50);VM.recenterMap();});$('#map').height(window.innerHeight-50);